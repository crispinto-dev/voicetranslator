<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Guida Turistica - Traduzione Simultanea</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }

    .container {
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      padding: 40px;
      max-width: 500px;
      width: 100%;
    }

    h1 {
      color: #333;
      margin-bottom: 10px;
      font-size: 28px;
      text-align: center;
    }

    .subtitle {
      color: #666;
      text-align: center;
      margin-bottom: 30px;
      font-size: 14px;
    }

    .info-box {
      background: #f0fdf4;
      border-left: 4px solid #10b981;
      padding: 15px;
      margin-bottom: 25px;
      border-radius: 8px;
      font-size: 13px;
      color: #555;
      line-height: 1.6;
    }

    .info-box strong {
      color: #065f46;
      display: block;
      margin-bottom: 8px;
    }

    .info-box ul {
      margin: 0;
      padding-left: 20px;
    }

    .info-box li {
      margin: 4px 0;
    }

    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      color: #555;
      font-weight: 500;
      margin-bottom: 8px;
      font-size: 14px;
    }

    select {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      font-size: 16px;
      transition: border-color 0.3s;
      background: white;
      cursor: pointer;
    }

    select:focus {
      outline: none;
      border-color: #10b981;
    }

    .checkbox-group {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 20px;
      padding: 12px;
      background: #f9fafb;
      border-radius: 8px;
    }

    .checkbox-group input[type="checkbox"] {
      width: 20px;
      height: 20px;
      cursor: pointer;
      accent-color: #10b981;
    }

    .checkbox-group label {
      margin: 0;
      cursor: pointer;
      user-select: none;
      font-size: 13px;
    }

    .btn {
      width: 100%;
      padding: 14px;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      margin-top: 10px;
    }

    .btn-primary {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
    }

    .btn-primary:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
    }

    .btn-primary:disabled {
      background: #d1d5db;
      cursor: not-allowed;
      transform: none;
    }

    .btn-danger {
      background: #ef4444;
      color: white;
    }

    .btn-danger:hover {
      background: #dc2626;
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(239, 68, 68, 0.4);
    }

    .status-container {
      margin-top: 20px;
      text-align: center;
    }

    .status {
      display: inline-block;
      padding: 12px 20px;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 500;
      margin-bottom: 10px;
    }

    .status.inactive {
      background: #f3f4f6;
      color: #6b7280;
    }

    .status.connecting {
      background: #fef3c7;
      color: #92400e;
    }

    .status.active {
      background: #d1fae5;
      color: #065f46;
      animation: pulse 2s infinite;
    }

    .status.listening {
      background: #dbeafe;
      color: #1e40af;
    }

    .status.translating {
      background: #fce7f3;
      color: #831843;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.85; }
    }

    .hidden {
      display: none;
    }

    .audio-info {
      font-size: 13px;
      color: #666;
      margin-top: 10px;
    }

    .warning {
      background: #fef3c7;
      border-left: 4px solid #f59e0b;
      padding: 12px;
      margin-top: 15px;
      border-radius: 8px;
      font-size: 12px;
      color: #92400e;
      line-height: 1.5;
    }

    .transcription-box {
      margin-top: 20px;
      padding: 15px;
      background: #f9fafb;
      border-radius: 10px;
      max-height: 200px;
      overflow-y: auto;
    }

    .transcription-box h3 {
      font-size: 12px;
      color: #6b7280;
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .transcription-box p {
      font-size: 14px;
      color: #333;
      line-height: 1.6;
      margin: 0;
    }

    .transcription-box p:empty::before {
      content: "In attesa di audio...";
      color: #9ca3af;
      font-style: italic;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ¤ Guida Turistica</h1>
    <p class="subtitle">Traduzione simultanea con duplicatore audio</p>

    <div class="info-box">
      <strong>ğŸ“Œ Setup Hardware:</strong>
      <ul>
        <li>Microfono: Lingua originale (es. Italiano)</li>
        <li>Output audio: Traduzione â†’ Duplicatore fisico</li>
        <li>Visitatori: Ricevono da duplicatore (cuffie/speaker)</li>
      </ul>
    </div>

    <div id="setupForm">
      <div class="form-group">
        <label for="targetLanguage">ğŸŒ Lingua Traduzione</label>
        <select id="targetLanguage">
          <option value="en">ğŸ‡¬ğŸ‡§ English</option>
          <option value="es">ğŸ‡ªğŸ‡¸ EspaÃ±ol</option>
          <option value="fr">ğŸ‡«ğŸ‡· FranÃ§ais</option>
          <option value="de">ğŸ‡©ğŸ‡ª Deutsch</option>
          <option value="it">ğŸ‡®ğŸ‡¹ Italiano</option>
          <option value="pt">ğŸ‡µğŸ‡¹ PortuguÃªs</option>
          <option value="zh">ğŸ‡¨ğŸ‡³ ä¸­æ–‡</option>
          <option value="ja">ğŸ‡¯ğŸ‡µ æ—¥æœ¬èª</option>
          <option value="ko">ğŸ‡°ğŸ‡· í•œêµ­ì–´</option>
          <option value="ar">ğŸ‡¸ğŸ‡¦ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option>
          <option value="ru">ğŸ‡·ğŸ‡º Ğ ÑƒÑÑĞºĞ¸Ğ¹</option>
        </select>
      </div>

      <div class="checkbox-group">
        <input type="checkbox" id="muteLocalAudio">
        <label for="muteLocalAudio">ğŸ”‡ Silenzia audio locale (solo output per duplicatore)</label>
      </div>

      <button class="btn btn-primary" id="startBtn">
        Avvia Tour
      </button>
    </div>

    <div id="activeSession" class="hidden">
      <div class="status-container">
        <div class="status inactive" id="status">Inattivo</div>
        <div class="audio-info" id="audioInfo">In attesa...</div>
      </div>

      <div class="transcription-box">
        <h3>Testo Originale</h3>
        <p id="originalText"></p>
      </div>

      <div class="warning">
        âš ï¸ Assicurati che le cuffie/speaker siano collegate al duplicatore audio
      </div>

      <button class="btn btn-danger" id="stopBtn">
        Termina Tour
      </button>
    </div>
  </div>

  <script type="module">
    import { RealtimeAgent, RealtimeSession } from '@openai/agents-realtime';

    class MuseumGuide {
      constructor() {
        this.session = null;
        this.agent = null;
        this.isRunning = false;
        this.targetLanguage = 'en';
        this.muteLocal = false;

        this.initializeUI();
      }

      initializeUI() {
        this.setupForm = document.getElementById('setupForm');
        this.activeSession = document.getElementById('activeSession');
        this.status = document.getElementById('status');
        this.audioInfo = document.getElementById('audioInfo');
        this.originalText = document.getElementById('originalText');
        this.targetLanguageSelect = document.getElementById('targetLanguage');
        this.muteLocalCheckbox = document.getElementById('muteLocalAudio');
        this.startBtn = document.getElementById('startBtn');
        this.stopBtn = document.getElementById('stopBtn');

        this.startBtn.addEventListener('click', () => this.startTour());
        this.stopBtn.addEventListener('click', () => this.stopTour());
      }

      async startTour() {
        try {
          this.targetLanguage = this.targetLanguageSelect.value;
          this.muteLocal = this.muteLocalCheckbox.checked;

          this.startBtn.disabled = true;
          this.updateStatus('connecting', 'â³ Connessione in corso...');

          // Get ephemeral token from backend
          const tokenResponse = await fetch('/api/realtime/token', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              language: this.targetLanguage,
              mode: 'museum'  // Museum guide mode with audio duplicator
            })
          });

          if (!tokenResponse.ok) {
            throw new Error('Failed to get token');
          }

          const { token, instructions } = await tokenResponse.json();
          console.log('[Guide] Got token, instructions:', instructions.substring(0, 100) + '...');

          // Create translator agent
          this.agent = new RealtimeAgent({
            name: 'MuseumGuide',
            instructions: instructions
          });

          // Create session with standard turn detection
          // Museum guide mode: standard VAD with automatic responses
          const sessionConfig = {
            model: 'gpt-4o-realtime-preview-2024-12-17',
            config: {
              turnDetection: {
                type: 'server_vad',
                threshold: 0.5,
                prefixPaddingMs: 300,
                silenceDurationMs: 500,
                createResponse: true,      // Automatic translation
                interruptResponse: true    // Standard behavior
              }
            }
          };

          this.session = new RealtimeSession(this.agent, sessionConfig);

          // Set up event handlers
          this.setupEventHandlers();

          // Connect
          await this.session.connect({ apiKey: token });
          console.log('[Guide] Connected to OpenAI Realtime API');

          // Mute local audio if requested
          if (this.muteLocal) {
            setTimeout(() => {
              const audioElements = document.querySelectorAll('audio');
              audioElements.forEach(audio => {
                audio.volume = 0;
                audio.muted = true;
                console.log('[Guide] Local audio muted');
              });
            }, 1000);
          }

          this.updateStatus('active', 'âœ… Tour Attivo');
          this.updateAudioInfo('Parla nel microfono...');
          this.setupForm.classList.add('hidden');
          this.activeSession.classList.remove('hidden');
          this.isRunning = true;

        } catch (error) {
          console.error('[Guide] Error starting tour:', error);
          this.updateStatus('inactive', 'âŒ Errore: ' + error.message);
          this.startBtn.disabled = false;
          alert('Errore nella connessione. Riprova.');
        }
      }

      async stopTour() {
        if (this.session) {
          await this.session.disconnect();
          this.session = null;
          this.agent = null;
        }

        this.setupForm.classList.remove('hidden');
        this.activeSession.classList.add('hidden');
        this.startBtn.disabled = false;
        this.isRunning = false;
        this.updateStatus('inactive', 'Tour terminato');
        this.originalText.textContent = '';
      }

      setupEventHandlers() {
        if (!this.session) return;

        this.session.on('transport_event', (event) => {
          console.log('[Realtime Event]', event.type);

          switch (event.type) {
            case 'conversation.item.input_audio_transcription.completed':
              if (event.transcript) {
                console.log('[Guide] Original text:', event.transcript);
                this.originalText.textContent = event.transcript;
              }
              break;

            case 'input_audio_buffer.speech_started':
              console.log('[Guide] Speech detected');
              this.updateStatus('listening', 'ğŸ¤ Rilevata voce');
              break;

            case 'input_audio_buffer.speech_stopped':
              console.log('[Guide] Speech stopped');
              this.updateStatus('translating', 'ğŸ”„ Traduzione...');
              break;

            case 'response.audio.delta':
              // Audio chunk being played
              this.updateStatus('active', 'ğŸ”Š Riproduzione traduzione');
              break;

            case 'response.audio.done':
              console.log('[Guide] Translation playback complete');
              this.updateStatus('active', 'âœ… Pronto');
              this.updateAudioInfo('In ascolto...');
              break;

            case 'response.done':
              console.log('[Guide] Response complete');
              break;

            case 'error':
              console.error('[Guide] Error:', event.error);
              this.updateStatus('inactive', 'âŒ Errore');
              break;
          }
        });

        this.session.on('error', (error) => {
          console.error('[Guide] Session error:', error);
          this.updateStatus('inactive', 'âŒ Errore di connessione');
        });
      }

      updateStatus(state, text) {
        this.status.className = 'status ' + state;
        this.status.textContent = text;
      }

      updateAudioInfo(text) {
        this.audioInfo.textContent = text;
      }
    }

    // Initialize
    const guide = new MuseumGuide();
  </script>
</body>
</html>
